machine:
  timezone: Asia/Shanghai
dependencies:
  cache_directories:
    - .cabal-sandbox
    - "~/.stack"
  override:
    - stack setup
    - stack build --only-dependencies
  post:
    - sudo apt-get update && sudo apt-get install s3cmd
  
test:
  override:
    - stack install
    - ./retouch.sh
    - expoundite build

deployment:
  prod:
    branch: master
    commands:
      - aws configure set preview.cloudfront true
      - echo -e "[default]\naccess_key = $S3CFG_ACCESSKEY\nsecret_key = $S3CFG_SECRETKEY\ndefault_mime_tipe = 'text/html'" > /home/ubuntu/.s3cfg
      - s3cmd --guess-mime-type --default-mime-type --recursive --delete-removed --acl-public sync _site/* s3://expoundite.net/
      - aws cloudfront create-invalidation --distribution-id E2WQV7PA6MMP54 --paths "/*"
